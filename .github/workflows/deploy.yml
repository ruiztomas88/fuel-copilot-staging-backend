name: Deploy to Azure VM

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Copy files to deployment directory
        run: |
          Write-Host "Copying files to C:\Users\Proyectos\fuel-analytics-backend"
          
          # Crear directorio si no existe
          if (-not (Test-Path "C:\Users\Proyectos\fuel-analytics-backend")) {
            New-Item -ItemType Directory -Path "C:\Users\Proyectos\fuel-analytics-backend" -Force
          }
          
          # Copiar archivos (excluyendo .git, .github, __pycache__, etc)
          $exclude = @('.git', '.github', '__pycache__', '.venv', 'venv', '.pytest_cache', '.mypy_cache', 'logs', 'data')
          Get-ChildItem -Path $env:GITHUB_WORKSPACE -Exclude $exclude | Copy-Item -Destination "C:\Users\Proyectos\fuel-analytics-backend" -Recurse -Force
          
          Write-Host "Files copied successfully"
        shell: powershell
      
      - name: Install dependencies if requirements.txt changed
        run: |
          cd C:\Users\Proyectos\fuel-analytics-backend
          
          # Verificar si requirements.txt cambi√≥
          $requirementsHash = (Get-FileHash -Path "requirements.txt" -Algorithm SHA256).Hash
          $hashFile = ".requirements.hash"
          
          $needsInstall = $false
          if (Test-Path $hashFile) {
            $oldHash = Get-Content $hashFile
            if ($oldHash -ne $requirementsHash) {
              Write-Host "requirements.txt has changed, installing dependencies..."
              $needsInstall = $true
            } else {
              Write-Host "requirements.txt unchanged, skipping installation"
            }
          } else {
            Write-Host "First deployment, installing dependencies..."
            $needsInstall = $true
          }
          
          if ($needsInstall) {
            # Activar virtual environment
            & .venv\Scripts\Activate.ps1
            
            # Instalar dependencias
            python -m pip install --upgrade pip
            pip install -r requirements.txt
            
            # Guardar hash del requirements.txt
            $requirementsHash | Out-File -FilePath $hashFile -Encoding utf8
            
            Write-Host "Dependencies installed successfully"
          }
        shell: powershell
      
      - name: Restart application
        run: |
          cd C:\Users\Proyectos\fuel-analytics-backend
          
          # Buscar y terminar proceso en puerto 8000 usando netstat
          Write-Host "Checking for process on port 8000..."
          $netstat = netstat -ano | Select-String ":8000" | Select-String "LISTENING"
          
          if ($netstat) {
            $line = $netstat.Line
            $pid = $line -split '\s+' | Select-Object -Last 1
            
            if ($pid -match '^\d+$') {
              Write-Host "Found process $pid on port 8000, terminating..."
              Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue
              Start-Sleep -Seconds 2
              Write-Host "Process terminated"
            }
          } else {
            Write-Host "No process found on port 8000"
          }
          
          # Activar virtual environment y ejecutar main.py
          Write-Host "Starting application..."
          & .venv\Scripts\Activate.ps1
          Start-Process -FilePath "python" -ArgumentList "main.py" -WorkingDirectory "C:\Users\Proyectos\fuel-analytics-backend" -WindowStyle Hidden
          
          Write-Host "Application started successfully"
        shell: powershell
