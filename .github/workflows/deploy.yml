name: Deploy to Azure VM

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Copy files to deployment directory
        run: |
          Write-Host "Copying files to C:\Users\devteam\Proyectos\fuel-analytics-backend"
          
          # Crear directorio si no existe
          if (-not (Test-Path "C:\Users\devteam\Proyectos\fuel-analytics-backend")) {
            New-Item -ItemType Directory -Path "C:\Users\devteam\Proyectos\fuel-analytics-backend" -Force
          }
          
          # Copiar archivos (excluyendo .git, .github, __pycache__, etc)
          $exclude = @('.git', '.github', '__pycache__', '.venv', 'venv', '.pytest_cache', '.mypy_cache', 'logs', 'data')
          Get-ChildItem -Path $env:GITHUB_WORKSPACE -Exclude $exclude | Copy-Item -Destination "C:\Users\devteam\Proyectos\fuel-analytics-backend" -Recurse -Force
          
          Write-Host "Files copied successfully"
        shell: powershell
      
      - name: Install dependencies if requirements.txt changed
        run: |
          cd C:\Users\devteam\Proyectos\fuel-analytics-backend
          
          # Verificar si requirements.txt cambi√≥
          $requirementsHash = (Get-FileHash -Path "requirements.txt" -Algorithm SHA256).Hash
          $hashFile = ".requirements.hash"
          
          $needsInstall = $false
          if (Test-Path $hashFile) {
            $oldHash = Get-Content $hashFile
            if ($oldHash -ne $requirementsHash) {
              Write-Host "requirements.txt has changed, installing dependencies..."
              $needsInstall = $true
            } else {
              Write-Host "requirements.txt unchanged, skipping installation"
            }
          } else {
            Write-Host "First deployment, installing dependencies..."
            $needsInstall = $true
          }
          
          if ($needsInstall) {
            # Activar virtual environment
            & .venv\Scripts\Activate.ps1
            
            # Instalar dependencias
            python -m pip install --upgrade pip
            pip install -r requirements.txt
            
            # Guardar hash del requirements.txt
            $requirementsHash | Out-File -FilePath $hashFile -Encoding utf8
            
            Write-Host "Dependencies installed successfully"
          }
        shell: powershell
      
      - name: Deployment complete
        run: |
          Write-Host "Deployment completed successfully!"
          Write-Host "Application files updated in C:\Users\devteam\Proyectos\fuel-analytics-backend"
        shell: powershell
