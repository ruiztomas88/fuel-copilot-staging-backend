"""
Comprehensive tests for AnalyticsService
Coverage: 100% of all methods
"""

from datetime import datetime, timedelta
from unittest.mock import MagicMock, patch

import pytest

from src.services.analytics_service_adapted import AnalyticsService


class TestAnalyticsService:
    """Test suite for AnalyticsService"""

    @pytest.fixture
    def service(self, mock_db_pool):
        """Create service with mocked dependencies"""
        with patch(
            "src.services.analytics_service_adapted.get_pool", return_value=mock_db_pool
        ):
            return AnalyticsService()

    def test_get_fleet_summary_success(self, service, mock_db_pool):
        """Test getting fleet summary successfully"""
        mock_cursor = mock_db_pool.get_connection().cursor()
        mock_cursor.fetchall.return_value = [
            {
                "truck_id": "RA1234",
                "truck_status": "MOVING",
                "mpg_current": 6.2,
                "fuel_pct": 75,
            },
            {
                "truck_id": "FF7702",
                "truck_status": "STOPPED",
                "mpg_current": 0.0,
                "fuel_pct": 45,
            },
            {
                "truck_id": "JX9900",
                "truck_status": "OFFLINE",
                "mpg_current": None,
                "fuel_pct": 20,
            },
        ]

        result = service.get_fleet_summary()

        assert result is not None
        assert result["total_trucks"] == 3
        assert result["active_trucks"] >= 1
        assert "avg_mpg" in result

    def test_get_fleet_summary_empty_fleet(self, service, mock_db_pool):
        """Test fleet summary with no trucks"""
        mock_cursor = mock_db_pool.get_connection().cursor()
        mock_cursor.fetchall.return_value = []

        result = service.get_fleet_summary()

        assert result["total_trucks"] == 0
        assert result["active_trucks"] == 0

    def test_get_truck_stats_success(self, service, mock_db_pool, sample_truck_data):
        """Test getting individual truck stats"""
        mock_cursor = mock_db_pool.get_connection().cursor()
        mock_cursor.fetchone.return_value = sample_truck_data

        result = service.get_truck_stats("RA1234", days=7)

        assert result is not None
        assert result["truck_id"] == "RA1234"
        assert "avg_mpg" in result or "mpg_current" in result

    def test_get_truck_stats_not_found(self, service, mock_db_pool):
        """Test getting stats for nonexistent truck"""
        mock_cursor = mock_db_pool.get_connection().cursor()
        mock_cursor.fetchone.return_value = None

        result = service.get_truck_stats("NONEXISTENT")

        assert result is None

    def test_calculate_kpis_success(self, service, mock_db_pool):
        """Test KPI calculation"""
        mock_cursor = mock_db_pool.get_connection().cursor()
        mock_cursor.fetchall.return_value = [
            {"mpg_current": 6.2, "consumption_gph": 10.5, "fuel_pct": 75},
            {"mpg_current": 5.8, "consumption_gph": 11.0, "fuel_pct": 45},
        ]

        result = service.calculate_kpis(days=7)

        assert result is not None
        assert "avg_mpg" in result
        assert "total_fuel_consumed" in result or "avg_consumption" in result

    def test_get_top_performers(self, service, mock_db_pool):
        """Test getting top performing trucks"""
        mock_cursor = mock_db_pool.get_connection().cursor()
        mock_cursor.fetchall.return_value = [
            {"truck_id": "RA1234", "avg_mpg": 6.5, "efficiency_score": 95},
            {"truck_id": "FF7702", "avg_mpg": 6.2, "efficiency_score": 90},
            {"truck_id": "JX9900", "avg_mpg": 5.8, "efficiency_score": 85},
        ]

        result = service.get_top_performers(limit=5, days=30)

        assert len(result) <= 5
        if result:
            assert result[0]["avg_mpg"] >= result[-1]["avg_mpg"]

    def test_get_bottom_performers(self, service, mock_db_pool):
        """Test getting worst performing trucks"""
        mock_cursor = mock_db_pool.get_connection().cursor()
        mock_cursor.fetchall.return_value = [
            {"truck_id": "AB1111", "avg_mpg": 4.2, "efficiency_score": 55},
            {"truck_id": "CD2222", "avg_mpg": 4.5, "efficiency_score": 60},
        ]

        result = service.get_bottom_performers(limit=5, days=30)

        assert len(result) <= 5
        if result:
            assert result[0]["avg_mpg"] <= result[-1]["avg_mpg"]

    def test_database_error_handling(self, service, mock_db_pool):
        """Test handling of database errors"""
        mock_cursor = mock_db_pool.get_connection().cursor()
        mock_cursor.execute.side_effect = Exception("Database error")

        with pytest.raises(Exception):
            service.get_fleet_summary()
